:: EndOfDayHub
<<silently>>
<<set $step = 0>><<ShowInfo>>
<<if $lastRentPaidDay is undefined>><<set $lastRentPaidDay = 0>><</if>>
<<set _rentPaidToday = false>>

<<if $hasHousing and $housingCost>>
	<<if ($day - $lastRentPaidDay) >= 30>>
		<<set $money -= $housingCost>>
		<<set $lastRentPaidDay = $day>>
		<<set _rentPaidToday = true>>
	<</if>>
<</if>>

<<if $worries.length>>
	<<set _expiredWorries = []>>
	<<for _i = 0; _i < $worries.length; _i++>>
		<<set $worries[_i].daysActive += 1>>
		<<if $worries[_i].daysActive >= $worries[_i].expiresIn>>
			<<set _expiredWorries.push($worries[_i])>>
		<</if>>
	<</for>>
	<<if _expiredWorries.length>>
		<<for _j = 0; _j < _expiredWorries.length; _j++>>
			<<set _exp = _expiredWorries[_j]>>
			<<set $familyHealth -= _exp.healthImpact>>
			<<set $worriesIgnored += 1>>
		<</for>>
		<<set $worries = $worries.filter(function(w){ return w.daysActive < w.expiresIn })>>
	<</if>>
<</if>>

<<set _worryChance = Math.min(30 + ($day * .5), 60)>>
<<set _worryRoll = random(1,100)>>
<<if _worryRoll <= _worryChance and $worries.length < 3>>
	<<set _availableWorries = $possibleWorries.filter(function(w){
		if (w.type === "maintenance" && !$hasCar) return false;
		return true;
	})>>
	<<set _pick = _availableWorries[random(0,_availableWorries.length-1)]>>
	<<set _newWorry = {
		type:_pick.type, severity:_pick.severity,
		description:_pick.description, expiresIn:_pick.expiresIn,
		healthImpact:_pick.healthImpact, cost:_pick.cost,
		daysActive:0
	}>>
	<<set $worries.push(_newWorry)>>
<</if>>

<<if $housingApplicationPending and $housingApplicationDaysRemaining <= 0>>
	<<goto "HousingApplicationResult">>
<</if>>

<<set _daysThreshold = ($hasHousing and $housingType === "Unaffordable") ? 15 : 999>>
<<if !$wifeMedicalEmergencyTriggered>>
	<<if $familyHealth <= 60 or ($day >= _daysThreshold and $hasHousing and $housingType === "Unaffordable")>>
		<<if !$overworkSicknessTriggered or ($overworkSicknessTriggered and !$workingExcessiveHours)>>
			<<set $wifeMedicalEmergencyTriggered = true>>
			<<goto "WifeMedicalEmergency">>
		<</if>>
	<</if>>
<</if>>

<<goto "EndOfDaySummary1">>
<</silently>>

:: EndOfDaySummary1
<h2 style="margin:0;">End of Day</h2>

<<if $pendingPayment>>
<div style="margin:3px 0;padding:4px 6px;border-radius:4px;background:rgba(56,178,75,.08);border-left:2px solid rgba(56,178,75,.3);font-size:.85em;">
	<strong>ğŸ’° Payment: $<<= $pendingPayment>></strong><br>
	<<set $money += $pendingPayment>><<set $totalIncomeEarned += $pendingPayment>>
	<<set $incomeHistory.push({amount:$pendingPayment,day:$day})>><<set $jobsCompleted += 1>>
	<nobr>Balance: $<<= $money>></nobr> Â·
	<nobr>Total: $<<= $totalIncomeEarned>></nobr> Â·
	<nobr>Jobs: <<= $jobsCompleted>></nobr>
	<<set $pendingPayment = 0>>
</div>
<<else>>
<div style="margin:3px 0;padding:4px 6px;border-radius:4px;background:rgba(99,179,237,.08);border-left:2px solid rgba(99,179,237,.3);font-size:.85em;">
	<strong>ğŸ’° No new payment today.</strong>
</div>
<</if>>

<<if _rentPaidToday>>
<div style="margin:3px 0;padding:4px 6px;border-radius:4px;background:rgba(217,83,79,.08);border-left:2px solid rgba(217,83,79,.3);font-size:.85em;">
	<strong>ğŸ  Rent paid: $<<= $housingCost>></strong><br>
	<nobr>New balance: $<<= $money>></nobr>
</div>
<</if>>

<<if $housingApplicationPending and $housingApplicationDaysRemaining>>
<div style="margin:3px 0;padding:4px 6px;border-radius:4px;background:rgba(99,179,237,.08);border-left:2px solid rgba(99,179,237,.3);font-size:.85em;">
	<strong>ğŸ  Housing application:</strong> <<= $pendingHousingType>><br>
	<nobr>~<<= $housingApplicationDaysRemaining>> business days</nobr>
	<<set _isWeekend = ($currentDayOfWeek == 5 or $currentDayOfWeek == 6)>>
	<<if _isWeekend>>
		<br><span style="font-size:.75em;color:#666;">ğŸ“… Weekend â€“ no processing</span>
	<</if>>
</div>
<</if>>

<div style="margin-top:4px;font-size:.85em;display:flex;justify-content:space-between;">
	<span></span>
	<span><<link "Next â–¶">><<goto "EndOfDaySummary2">><</link>></span>
</div>

:: EndOfDaySummary2
<h2 style="margin:0 0 4px 0;">End of Day â€“ Family</h2>

<<if _expiredWorries and _expiredWorries.length>>
<div style="margin:3px 0;padding:4px 6px;border-radius:4px;background:rgba(217,83,79,.08);border-left:2px solid rgba(217,83,79,.3);font-size:.85em;">
	<strong>âš ï¸ Unresolved worries</strong>
	<div style="font-size:.8em;margin-top:2px;">You couldnâ€™t address <<= _expiredWorries.length>> concern<<if _expiredWorries.length > 1>>s<</if>>:</div>
	<<for _k = 0; _k < _expiredWorries.length; _k++>>
		<<set _ew = _expiredWorries[_k]>>
		<div style="margin-top:1px;">
			â€¢ <<= _ew.description>> (<nobr>-<<= _ew.healthImpact>>%</nobr>)
		</div>
	<</for>>
</div>
<</if>>

<<if $worries.length>>
<div style="margin:3px 0;padding:4px 6px;border-radius:4px;background:rgba(236,201,75,.08);border-left:2px solid rgba(236,201,75,.3);font-size:.85em;">
	<strong>âš ï¸ Active worries:</strong>
	<<for _i = 0; _i < $worries.length; _i++>>
		<<set _w = $worries[_i]>>
		<<set _sevText = "Low">>
		<<if _w.severity >= 2 and _w.severity <= 3>><<set _sevText = "Medium">>
		<<elseif _w.severity >= 4>><<set _sevText = "High">><</if>>
		<div style="margin-top:1px;">
			<nobr>Â· Severity: <<= _sevText>> â€“ <<= _w.description>> (<<= _w.daysActive>>d)</nobr>
		</div>
	<</for>>
</div>
<<else>>
<div style="margin:3px 0;padding:4px 6px;border-radius:4px;background:rgba(236,201,75,.08);border-left:2px solid rgba(236,201,75,.3);font-size:.85em;">
	âœ“ No current worries.
</div>
<</if>>

<div style="margin-top:4px;font-size:.85em;display:flex;justify-content:space-between;">
	<span><<link "â—€ Back">><<goto "EndOfDaySummary1">><</link>></span>
	<span><<link "Next â–¶">><<goto "Hub">><</link>></span>
</div>

<<if $worries.length>>
	<<include "AddressWorries">>
<</if>>
